
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Objective-C中的Block - OneV's Den</title>
	<meta name="author" content="onevcat">

	
	<meta name="description" content="Objective-C中的Block 技术是需要沉淀的。接触iOS开发也有大半年时间了，从一开始的纯白到现在自我感觉略懂一点，其实进步是明显的。无数牛人表示技术博是完成菜鸟到高手蜕变的途径之一，虽然这个博客并非是为技术而生，但是也许作为工科背景下的我来说，每天都写文艺的东西显然并不现实。 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="OneV's Den" type="application/atom+xml">
	
	<link rel="canonical" href="http://onevcat.com/2011/11/objective-c%E4%B8%AD%E7%9A%84block/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<script type="text/javascript">var switchTo5x=false;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "496dac80-40ba-487b-b557-af2d3629eb28", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		document.write("<img src='http://www.gravatar.com/avatar/" + MD5("onev@onevcat.com") + "?s=160' alt='Profile Picture' style='width: 160px;'");
	</script>
</div>
<h1><a href="/">OneV's Den</a></h1>
<p class="subtitle">上善若水，人淡如菊</p>
<p class="subtitle">iOS/Mac，Unity3D开发者，现就职于日本创意公司Kayac，正在修行，探求创意之源</p>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/about/">关于我</a></li>
  <li><a href="/blog/archives">全部文章</a></li>
  <li><a href="/showcase">我的项目</a></li>
  <li><a href="http://pomo.onevcat.com">	Pomo Do - 番茄工作法工具</a></li>
  <li><a href="http://ourmoney.onevcat.com">	Our Money - 多人同步记账</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="weibo" href="http://www.weibo.com/onevcat" title="Sina Weibo">Weibo</a>
		
		
		<a class="facebook" href="http://www.facebook.com/onevcat" title="Facebook">Facebook</a>
		
		
		
		<a class="twitter" href="http://twitter.com/onevcat" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/onevcat" title="GitHub">GitHub</a>
		
		
		
		<a class="pinterest" href="https://pinterest.com/onevcat" title="Pinterest">Pinterest</a>
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
<a href="http://eepurl.com/wNSkj"><script type="text/javascript" language="JavaScript" src="http://onevcat.us5.list-manage.com/subscriber-count?b=32&u=3244d6df-04b2-4c3b-bfb2-06ac1dd40a00&id=cfde66e507"></script></a>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Objective-C中的Block</h1>
	<div class="entry-content" itemprop="articleBody"><p><!--:zh--><a href="http://www.onevcat.com/wp-content/uploads/2011/11/block1.png"><img class="aligncenter size-full wp-image-265" title="block1" src="http://www.onevcat.com/wp-content/uploads/2011/11/block1-e1320760029302.png" alt="" width="564" height="141" data-pinit="registered" /></a></p>

<p>技术是需要沉淀的。接触iOS开发也有大半年时间了，从一开始的纯白到现在自我感觉略懂一点，其实进步是明显的。无数牛人表示技术博是完成菜鸟到高手蜕变的途径之一，虽然这个博客并非是为技术而生，但是也许作为工科背景下的我来说，每天都写文艺的东西显然并不现实。于是就有了这个集子：能工巧匠集。用这篇开篇，</p>

<p><!--:--><!--more--><!--:zh--></p>

<p>写一些在开发过程中的积累和感悟，大部分应该是Objectiv-C和XCode的内容，包括基本语法特性和小技巧，或者自己喜欢的一些开源代码的用法分析等等。也许以后会扩展到Unity3D或者UDK的一些3D引擎的心得，当然也有可能会有别的一些自己认为值得分享的东西。这个集子的目的，一来是记录自己一步一步成长的脚印，二来也算是为新来者铺一条直一点的道路。集子里的东西仅仅是自己的心得体会，高手路过请一笑置之..感恩。</p>

<p>iOS SDK 4.0开始，Apple引入了block这一特性，而自从block特性诞生之日起，似乎它就受到了Apple特殊的照顾和青睐。字面上说，block就是一个代码块，但是它的神奇之处在于在内联(inline)执行的时候(这和C++很像)还可以传递参数。同时block本身也可以被作为参数在方法和函数间传递，这就给予了block无限的可能。</p>

<p>先来看一个简单的block吧：</p>

<p>[gist id=3754865]
<p class="objc" style="font-family: monospace;">以上定义了一个block变量，block本身是一个程序段，因此有返回值，这里这个block返回的类型为BOOL。&#8221;^&#8221;符号表示开始定义，block的名称紧跟在^符号之后，为isInputEven，也即以后使用inline方式调用该block时所需要的名称。这段block接受一个int型的参数，而在等号后面的int input是对传入的int类型的说明，在该block内，该int的局部变量名为input。</p>
<p class="objc" style="font-family: monospace;">调用这个block非常简单，类似调用c函数的方式即可：</p>
[gist id= 3754879]
<p class="objc" style="font-family: monospace;"></p>
<p class="objc" style="font-family: monospace;">不出意外的话输出为<strong>-101 is not an even number</strong></p>
<p class="objc" style="font-family: monospace;">以上的用法没有什么特别之处，只不过是简单的内联函数罢了。但是block的神奇之处在于block外的变量可以无缝地直接在block内部使用，比如这样：</p>
[gist id=3754886]</p>

<p>输出为<strong>Ordering 10 units, final price is: $19.90</strong></p>

<p>相当开心，block外的price成功地传递到了block内部，这意味着内联函数可以使用本地变量，但是需要注意的是，你不能在block内部改变本地变量的值，比如在^{}里写price = 0.99这样的语句的话，你亲爱的compiler一定是会complain的。而更需要注意的是price这样的局部变量的变化是不会体现在block里的！比如接着上面写成这样的话：</p>

<p>[gist id=3754892]</p>

<p>输出还是<strong>Ordering 10 units, final price is: $19.90，</strong>可以理解为在block内局部变量price是readonly的。如果确实需要传递给block变量值的话，可以考虑下面两种方法：</p>

<p>1、将局部变量声明为__block，表示将会由block进行操作，比如：<br />
[gist id=3754895]</p>

<p>此时输出为<strong>With block storage modifier – Ordering 10 units, final price is: $9.90</strong></p>

<p>2、使用实例变量——这个比较没什么好说的，实例内的变量横行于整个实例内..可谓霸道无敌&#8230;=_=</p>

<p>block外的对象和基本数据一样，也可以作为block的参数。而让人开心的是，block将自动retain传递进来的参数，而不需担心在block执行之前局部对象变量已经被释放的问题。这里就不深究这个问题了，只要严格遵循Apple的thread safe来写，block的内存管理并不存在问题。</p>

<p>由于block的灵活的机制，导致iOS SDK 4.0开始，Apple大力提倡在各种地方应用block机制。最典型的当属UIView的动画了：在4.0前写一个UIView的Animation大概是这样的：</p>

<p>[gist id= 3754903]</p>

<p>在一个不知名的小角落里的begin/commit两行代码间写下需要进行的动作，然后静待发生。而4.0后这样的方法直接被discouraged了，取而代之的正是block：</p>

<p>[gist id=3754908]<br />
简单明了，一切就这么发生了..</p>

<p>可能有人会觉得block的语法很奇怪，不像是OOP的风格，诚然直接使用的block看起来破坏了OOP的结构，也让实例的内存管理出现了某些“看上去奇怪”的现象。但是通过typedef的方法，可以将block进行简单包装，让它的behaviour更靠近对象一些：
<ul>
	<li>typedef double (^unary_operation_t)(double op);</li>
</ul>
定义了一个接受一个double型作为变量，类型为unary_operation_t的block，之后在使用前用类似C的语法声明一个unary_operation_t类型的&#8221;实例&#8221;，并且定义内容后便可以直接使用这个block了～</p>

<p>[gist id=3754919]</p>

<p>啰嗦一句的还是内存管理的问题，block始终不是对象，而block的内存管理自然也是和普通对象不一样。系统会为block在堆上分配内存，而当把block当做对象进行处理时（比如将其压入一个NSMutableArray），我们需要获取它的一份copy（比如[square copy]），并且在Array retain了这个block后将其释放（[square autorelease]是不错的选择）。而对于block本身和调用该block的实例，则可以放心：SDK会将调用block的实例自动retain，直至block执行完毕后再对实例release，因此不会出现block执行到一半，实例就被dealloc这样的尴尬的局面。</p>

<p>iOS SDK 4.0以后，随着block的加入很多特性也随之添加或者发生了升级。Apple所推荐的block使用范围包括以下几个方面：
<ul>
	<li>枚举——通过block获取枚举对象或控制枚举进程</li>
	<li>View动画——简单明了的方式规定动画</li>
	<li>排序——在block内写排序算法</li>
	<li>通知——当某事件发生后执行block内的代码</li>
	<li>错误处理——当错误发生时执行block代码</li>
	<li>完成处理——当方法执行完毕后执行block代码</li>
	<li>GCD多线程——多线程控制，关于这个以后有机会再写…</li>
</ul>
仔细研读4.0的SDK的话，会发现很多常用类中都加入了不少带block作为参数的方法，改变固有思维习惯，适应并尽可能利用block给程序上带来的便捷，无疑是提高效率和使代码优雅的很好的途径～<!--:--><!--:en-->&nbsp;</p>

<p>写一些在开发过程中的积累和感悟，大部分应该是Objectiv-C和XCode的内容，包括基本语法特性和小技巧，或者自己喜欢的一些开源代码的用法分析等等。也许以后会扩展到Unity3D或者UDK的一些3D引擎的心得，当然也有可能会有别的一些自己认为值得分享的东西。这个集子的目的，一来是记录自己一步一步成长的脚印，二来也算是为新来者铺一条直一点的道路。集子里的东西仅仅是自己的心得体会，高手路过请一笑置之..感恩。</p>

<p>iOS SDK 4.0开始，Apple引入了block这一特性，而自从block特性诞生之日起，似乎它就受到了Apple特殊的照顾和青睐。字面上说，block就是一个代码块，但是它的神奇之处在于在内联(inline)执行的时候(这和C++很像)还可以传递参数。同时block本身也可以被作为参数在方法和函数间传递，这就给予了block无限的可能。</p>

<p>先来看一个简单的block吧：
<blockquote style="border-left-width: 4px; border-left-style: solid; border-left-color: #777777; margin-left: 34px; padding-left: 10px;">
<pre class="objc" style="font-family: monospace; margin: 8px;"><span style="color: #11740a; font-style: italic;">// Defining a block variable</span>
<span style="color: #a61390;">BOOL</span> <span style="color: #002200;">(</span><span style="color: #002200;">^</span>isInputEven<span style="color: #002200;">)</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span><span style="color: #002200;">)</span> <span style="color: #002200;">=</span> <span style="color: #002200;">^</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span> input<span style="color: #002200;">)</span>
<span style="color: #002200;">{</span>
  <span style="color: #a61390;">if</span> <span style="color: #002200;">(</span>input <span style="color: #002200;">%</span> <span style="color: #2400d9;">2</span> <span style="color: #002200;">==</span> <span style="color: #2400d9;">0</span><span style="color: #002200;">)</span>
    <span style="color: #a61390;">return</span> <span style="color: #a61390;">YES</span>;
  <span style="color: #a61390;">else</span>
    <span style="color: #a61390;">return</span> <span style="color: #a61390;">NO</span>;
<span style="color: #002200;">}</span>;</pre>
</blockquote>
<p class="objc" style="font-family: monospace;">以上定义了一个block变量，block本身是一个程序段，因此有返回值，这里这个block返回的类型为BOOL。&#8221;^&#8221;符号表示开始定义，block的名称紧跟在^符号之后，为isInputEven，也即以后使用inline方式调用该block时所需要的名称。这段block接受一个int型的参数，而在等号后面的int input是对传入的int类型的说明，在该block内，该int的局部变量名为input。</p>
<p class="objc" style="font-family: monospace;">调用这个block非常简单，类似调用c函数的方式即可：</p></p>

<p><blockquote style="border-left-width: 4px; border-left-style: solid; border-left-color: #777777; margin-left: 34px; padding-left: 10px;">
<pre class="objc" style="font-family: monospace; margin: 8px;"><span style="color: #11740a; font-style: italic;">// Call similar to a C function call</span>
<span style="color: #a61390;">int</span> x <span style="color: #002200;">=</span> <span style="color: #002200;">-</span><span style="color: #2400d9;">101</span>;
NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"%d %@ number"</span>, x, isInputEven<span style="color: #002200;">(</span>x<span style="color: #002200;">)</span> ? <span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"is an even"</span> <span style="color: #002200;">:</span> <span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"is not an even"</span><span style="color: #002200;">)</span>;</pre>
</blockquote>
<p class="objc" style="font-family: monospace;"></p>
<p class="objc" style="font-family: monospace;">不出意外的话输出为<strong>-101 is not an even number</strong></p>
<p class="objc" style="font-family: monospace;">以上的用法没有什么特别之处，只不过是简单的内联函数罢了。但是block的神奇之处在于block外的变量可以无缝地直接在block内部使用，比如这样：</p></p>

<p><blockquote>
<pre class="objc" style="font-family: monospace;"><span style="color: #a61390;">float</span> price <span style="color: #002200;">=</span> <span style="color: #2400d9;">1.99</span>;</pre></blockquote></p>

<p><span style="color: #a61390;">float</span> <span style="color: #002200;">(</span><span style="color: #002200;">^</span>finalPrice<span style="color: #002200;">)</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span><span style="color: #002200;">)</span> <span style="color: #002200;">=</span> <span style="color: #002200;">^</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span> quantity<span style="color: #002200;">)</span>
<span style="color: #002200;">{</span>
  <span style="color: #11740a; font-style: italic;">// Notice local variable price is </span>
  <span style="color: #11740a; font-style: italic;">// accessible in the block</span>
  <span style="color: #a61390;">return</span> quantity <span style="color: #002200;">*</span> price;
<span style="color: #002200;">}</span>;</p>

<p><span style="color: #a61390;">int</span> orderQuantity <span style="color: #002200;">=</span> <span style="color: #2400d9;">10</span>;<br />
NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">&#8220;Ordering %d units, final price is: $%2.2f&#8221;</span>, orderQuantity, finalPrice<span style="color: #002200;">(</span>orderQuantity<span style="color: #002200;">)</span><span style="color: #002200;">)</span>;

输出为<strong>Ordering 10 units, final price is: $19.90</strong></p>

<p>相当开心，block外的price成功地传递到了block内部，这意味着内联函数可以使用本地变量，但是需要注意的是，你不能在block内部改变本地变量的值，比如在^{}里写price = 0.99这样的语句的话，你亲爱的compiler一定是会complain的。而更需要注意的是price这样的局部变量的变化是不会体现在block里的！比如接着上面写成这样的话：
<blockquote>
<pre class="objc" style="font-family: monospace;">price <span style="color: #002200;">=</span> .99;
NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"Ordering %d units, final price is: $%2.2f"</span>, orderQuantity, finalPrice<span style="color: #002200;">(</span>orderQuantity<span style="color: #002200;">)</span><span style="color: #002200;">)</span>;</pre>
</blockquote>
输出还是<strong>Ordering 10 units, final price is: $19.90，</strong>可以理解为在block内局部变量price是readonly的。如果确实需要传递给block变量值的话，可以考虑下面两种方法：</p>

<p>1、将局部变量声明为__block，表示将会由block进行操作，比如：
<blockquote>
<pre class="objc" style="font-family: monospace;"><span style="color: #11740a; font-style: italic;">// Use the __block storage modifier to allow changes to 'price'</span>
__block <span style="color: #a61390;">float</span> price <span style="color: #002200;">=</span> <span style="color: #2400d9;">1.99</span>;</pre></blockquote></p>

<p><span style="color: #a61390;">float</span> <span style="color: #002200;">(</span><span style="color: #002200;">^</span>finalPrice<span style="color: #002200;">)</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span><span style="color: #002200;">)</span> <span style="color: #002200;">=</span> <span style="color: #002200;">^</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span> quantity<span style="color: #002200;">)</span>
<span style="color: #002200;">{</span>
  <span style="color: #a61390;">return</span> quantity <span style="color: #002200;">*</span> price;
<span style="color: #002200;">}</span>;</p>

<p><span style="color: #a61390;">int</span> orderQuantity <span style="color: #002200;">=</span> <span style="color: #2400d9;">10</span>;<br />
price <span style="color: #002200;">=</span> .99;</p>

<p>NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">&#8220;With block storage modifier - Ordering %d units, final price is: $%2.2f&#8221;</span>, orderQuantity, finalPrice<span style="color: #002200;">(</span>orderQuantity<span style="color: #002200;">)</span><span style="color: #002200;">)</span>;

此时输出为<strong>With block storage modifier – Ordering 10 units, final price is: $9.90</strong></p>

<p>2、使用实例变量——这个比较没什么好说的，实例内的变量横行于整个实例内..可谓霸道无敌&#8230;=_=</p>

<p>block外的对象和基本数据一样，也可以作为block的参数。而让人开心的是，block将自动retain传递进来的参数，而不需担心在block执行之前局部对象变量已经被释放的问题。这里就不深究这个问题了，只要严格遵循Apple的thread safe来写，block的内存管理并不存在问题。</p>

<p>由于block的灵活的机制，导致iOS SDK 4.0开始，Apple大力提倡在各种地方应用block机制。最典型的当属UIView的动画了：在4.0前写一个UIView的Animation大概是这样的：
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> [</span><span style="color: #743ca6;">UIView</span>beginAnimations<span style="color: #000000;">:</span><span style="color: #da2e24;">@"ToggleSiblings"</span>context<span style="color: #000000;">:</span><span style="color: #c22a9f;">nil</span><span style="color: #000000;">];</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> </span><span style="color: #000000;">[UIView setAnimationTransition:UIViewAnimationTransitionCurlUp </span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> forView:<span style="color: #c22a9f;">self</span>.view cache:<span style="color: #c22a9f;">YES</span>];</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> </span><span style="color: #000000;">[</span><span style="color: #743ca6;">UIView</span>setAnimationDuration<span style="color: #000000;">:</span><span style="color: #2526d3;">1.0</span><span style="color: #000000;">];</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #008419;">// Make your changes</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;">[</span><span style="color: #743ca6;">UIView</span>commitAnimations<span style="color: #000000;">];</span></pre>
</blockquote>
<p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"></p>
在一个不知名的小角落里的begin/commit两行代码间写下需要进行的动作，然后静待发生。而4.0后这样的方法直接被discouraged了，取而代之的正是block：
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> [</span><span style="color: #743ca6;">UIView</span>animateWithDuration<span style="color: #000000;">:</span><span style="color: #2526d3;">5.0</span>animations<span style="color: #000000;">:^{</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">view.opacity = <span style="color: #2526d3;">0.5</span>;</pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">}];</pre>
</blockquote>
简单明了，一切就这么发生了..</p>

<p>可能有人会觉得block的语法很奇怪，不像是OOP的风格，诚然直接使用的block看起来破坏了OOP的结构，也让实例的内存管理出现了某些“看上去奇怪”的现象。但是通过typedef的方法，可以将block进行简单包装，让它的behaviour更靠近对象一些：
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';"><span style="color: #c22a9f;">typedef</span> <span style="color: #c22a9f;">double</span> (^unary_operation_t)(<span style="color: #c22a9f;">double</span> op);</pre>
</blockquote>
定义了一个接受一个double型作为变量，类型为unary_operation_t的block，之后在使用前用类似C的语法声明一个unary_operation_t类型的&#8221;实例&#8221;，并且定义内容后便可以直接使用这个block了～
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #478186;">unary_operation_t<span style="color: #000000;"> square;</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">square = ^(<span style="color: #c22a9f;">double</span> operand) {</pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';"><span style="color: #c22a9f;">return</span> operand * operand;</pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">}</pre>
</blockquote>
啰嗦一句的还是内存管理的问题，block始终不是对象，而block的内存管理自然也是和普通对象不一样。系统会为block在堆上分配内存，而当把block当做对象进行处理时（比如将其压入一个NSMutableArray），我们需要获取它的一份copy（比如[square copy]），并且在Array retain了这个block后将其释放（[square autorelease]是不错的选择）。而对于block本身和调用该block的实例，则可以放心：SDK会将调用block的实例自动retain，直至block执行完毕后再对实例release，因此不会出现block执行到一半，实例就被dealloc这样的尴尬的局面。</p>

<p>iOS SDK 4.0以后，随着block的加入很多特性也随之添加或者发生了升级。Apple所推荐的block使用范围包括以下几个方面：
<ul>
	<li>枚举——通过block获取枚举对象或控制枚举进程</li>
	<li>View动画——简单明了的方式规定动画</li>
	<li>排序——在block内写排序算法</li>
	<li>通知——当某事件发生后执行block内的代码</li>
	<li>错误处理——当错误发生时执行block代码</li>
	<li>完成处理——当方法执行完毕后执行block代码</li>
	<li>GCD多线程——多线程控制，关于这个以后有机会再写…</li>
</ul>
仔细研读4.0的SDK的话，会发现很多常用类中都加入了不少带block作为参数的方法，改变固有思维习惯，适应并尽可能利用block给程序上带来的便捷，无疑是提高效率和使代码优雅的很好的途径～</p>

<p><!--:--><!--:ja-->&nbsp;</p>

<p>写一些在开发过程中的积累和感悟，大部分应该是Objectiv-C和XCode的内容，包括基本语法特性和小技巧，或者自己喜欢的一些开源代码的用法分析等等。也许以后会扩展到Unity3D或者UDK的一些3D引擎的心得，当然也有可能会有别的一些自己认为值得分享的东西。这个集子的目的，一来是记录自己一步一步成长的脚印，二来也算是为新来者铺一条直一点的道路。集子里的东西仅仅是自己的心得体会，高手路过请一笑置之..感恩。</p>

<p>iOS SDK 4.0开始，Apple引入了block这一特性，而自从block特性诞生之日起，似乎它就受到了Apple特殊的照顾和青睐。字面上说，block就是一个代码块，但是它的神奇之处在于在内联(inline)执行的时候(这和C++很像)还可以传递参数。同时block本身也可以被作为参数在方法和函数间传递，这就给予了block无限的可能。</p>

<p>先来看一个简单的block吧：
<blockquote style="border-left-width: 4px; border-left-style: solid; border-left-color: #777777; margin-left: 34px; padding-left: 10px;">
<pre class="objc" style="font-family: monospace; margin: 8px;"><span style="color: #11740a; font-style: italic;">// Defining a block variable</span>
<span style="color: #a61390;">BOOL</span> <span style="color: #002200;">(</span><span style="color: #002200;">^</span>isInputEven<span style="color: #002200;">)</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span><span style="color: #002200;">)</span> <span style="color: #002200;">=</span> <span style="color: #002200;">^</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span> input<span style="color: #002200;">)</span>
<span style="color: #002200;">{</span>
  <span style="color: #a61390;">if</span> <span style="color: #002200;">(</span>input <span style="color: #002200;">%</span> <span style="color: #2400d9;">2</span> <span style="color: #002200;">==</span> <span style="color: #2400d9;">0</span><span style="color: #002200;">)</span>
    <span style="color: #a61390;">return</span> <span style="color: #a61390;">YES</span>;
  <span style="color: #a61390;">else</span>
    <span style="color: #a61390;">return</span> <span style="color: #a61390;">NO</span>;
<span style="color: #002200;">}</span>;</pre>
</blockquote>
<p class="objc" style="font-family: monospace;">以上定义了一个block变量，block本身是一个程序段，因此有返回值，这里这个block返回的类型为BOOL。&#8221;^&#8221;符号表示开始定义，block的名称紧跟在^符号之后，为isInputEven，也即以后使用inline方式调用该block时所需要的名称。这段block接受一个int型的参数，而在等号后面的int input是对传入的int类型的说明，在该block内，该int的局部变量名为input。</p>
<p class="objc" style="font-family: monospace;">调用这个block非常简单，类似调用c函数的方式即可：</p></p>

<p><blockquote style="border-left-width: 4px; border-left-style: solid; border-left-color: #777777; margin-left: 34px; padding-left: 10px;">
<pre class="objc" style="font-family: monospace; margin: 8px;"><span style="color: #11740a; font-style: italic;">// Call similar to a C function call</span>
<span style="color: #a61390;">int</span> x <span style="color: #002200;">=</span> <span style="color: #002200;">-</span><span style="color: #2400d9;">101</span>;
NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"%d %@ number"</span>, x, isInputEven<span style="color: #002200;">(</span>x<span style="color: #002200;">)</span> ? <span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"is an even"</span> <span style="color: #002200;">:</span> <span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"is not an even"</span><span style="color: #002200;">)</span>;</pre>
</blockquote>
<p class="objc" style="font-family: monospace;"></p>
<p class="objc" style="font-family: monospace;">不出意外的话输出为<strong>-101 is not an even number</strong></p>
<p class="objc" style="font-family: monospace;">以上的用法没有什么特别之处，只不过是简单的内联函数罢了。但是block的神奇之处在于block外的变量可以无缝地直接在block内部使用，比如这样：</p></p>

<p><blockquote>
<pre class="objc" style="font-family: monospace;"><span style="color: #a61390;">float</span> price <span style="color: #002200;">=</span> <span style="color: #2400d9;">1.99</span>;</pre></blockquote></p>

<p><span style="color: #a61390;">float</span> <span style="color: #002200;">(</span><span style="color: #002200;">^</span>finalPrice<span style="color: #002200;">)</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span><span style="color: #002200;">)</span> <span style="color: #002200;">=</span> <span style="color: #002200;">^</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span> quantity<span style="color: #002200;">)</span>
<span style="color: #002200;">{</span>
  <span style="color: #11740a; font-style: italic;">// Notice local variable price is </span>
  <span style="color: #11740a; font-style: italic;">// accessible in the block</span>
  <span style="color: #a61390;">return</span> quantity <span style="color: #002200;">*</span> price;
<span style="color: #002200;">}</span>;</p>

<p><span style="color: #a61390;">int</span> orderQuantity <span style="color: #002200;">=</span> <span style="color: #2400d9;">10</span>;<br />
NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">&#8220;Ordering %d units, final price is: $%2.2f&#8221;</span>, orderQuantity, finalPrice<span style="color: #002200;">(</span>orderQuantity<span style="color: #002200;">)</span><span style="color: #002200;">)</span>;

输出为<strong>Ordering 10 units, final price is: $19.90</strong></p>

<p>相当开心，block外的price成功地传递到了block内部，这意味着内联函数可以使用本地变量，但是需要注意的是，你不能在block内部改变本地变量的值，比如在^{}里写price = 0.99这样的语句的话，你亲爱的compiler一定是会complain的。而更需要注意的是price这样的局部变量的变化是不会体现在block里的！比如接着上面写成这样的话：
<blockquote>
<pre class="objc" style="font-family: monospace;">price <span style="color: #002200;">=</span> .99;
NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">"Ordering %d units, final price is: $%2.2f"</span>, orderQuantity, finalPrice<span style="color: #002200;">(</span>orderQuantity<span style="color: #002200;">)</span><span style="color: #002200;">)</span>;</pre>
</blockquote>
输出还是<strong>Ordering 10 units, final price is: $19.90，</strong>可以理解为在block内局部变量price是readonly的。如果确实需要传递给block变量值的话，可以考虑下面两种方法：</p>

<p>1、将局部变量声明为__block，表示将会由block进行操作，比如：
<blockquote>
<pre class="objc" style="font-family: monospace;"><span style="color: #11740a; font-style: italic;">// Use the __block storage modifier to allow changes to 'price'</span>
__block <span style="color: #a61390;">float</span> price <span style="color: #002200;">=</span> <span style="color: #2400d9;">1.99</span>;</pre></blockquote></p>

<p><span style="color: #a61390;">float</span> <span style="color: #002200;">(</span><span style="color: #002200;">^</span>finalPrice<span style="color: #002200;">)</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span><span style="color: #002200;">)</span> <span style="color: #002200;">=</span> <span style="color: #002200;">^</span><span style="color: #002200;">(</span><span style="color: #a61390;">int</span> quantity<span style="color: #002200;">)</span>
<span style="color: #002200;">{</span>
  <span style="color: #a61390;">return</span> quantity <span style="color: #002200;">*</span> price;
<span style="color: #002200;">}</span>;</p>

<p><span style="color: #a61390;">int</span> orderQuantity <span style="color: #002200;">=</span> <span style="color: #2400d9;">10</span>;<br />
price <span style="color: #002200;">=</span> .99;</p>

<p>NSLog<span style="color: #002200;">(</span><span style="color: #bf1d1a;">@</span><span style="color: #bf1d1a;">&#8220;With block storage modifier - Ordering %d units, final price is: $%2.2f&#8221;</span>, orderQuantity, finalPrice<span style="color: #002200;">(</span>orderQuantity<span style="color: #002200;">)</span><span style="color: #002200;">)</span>;

此时输出为<strong>With block storage modifier – Ordering 10 units, final price is: $9.90</strong></p>

<p>2、使用实例变量——这个比较没什么好说的，实例内的变量横行于整个实例内..可谓霸道无敌&#8230;=_=</p>

<p>block外的对象和基本数据一样，也可以作为block的参数。而让人开心的是，block将自动retain传递进来的参数，而不需担心在block执行之前局部对象变量已经被释放的问题。这里就不深究这个问题了，只要严格遵循Apple的thread safe来写，block的内存管理并不存在问题。</p>

<p>由于block的灵活的机制，导致iOS SDK 4.0开始，Apple大力提倡在各种地方应用block机制。最典型的当属UIView的动画了：在4.0前写一个UIView的Animation大概是这样的：
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> [</span><span style="color: #743ca6;">UIView</span>beginAnimations<span style="color: #000000;">:</span><span style="color: #da2e24;">@"ToggleSiblings"</span>context<span style="color: #000000;">:</span><span style="color: #c22a9f;">nil</span><span style="color: #000000;">];</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> </span><span style="color: #000000;">[UIView setAnimationTransition:UIViewAnimationTransitionCurlUp </span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> forView:<span style="color: #c22a9f;">self</span>.view cache:<span style="color: #c22a9f;">YES</span>];</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> </span><span style="color: #000000;">[</span><span style="color: #743ca6;">UIView</span>setAnimationDuration<span style="color: #000000;">:</span><span style="color: #2526d3;">1.0</span><span style="color: #000000;">];</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #008419;">// Make your changes</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;">[</span><span style="color: #743ca6;">UIView</span>commitAnimations<span style="color: #000000;">];</span></pre>
</blockquote>
<p style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"></p>
在一个不知名的小角落里的begin/commit两行代码间写下需要进行的动作，然后静待发生。而4.0后这样的方法直接被discouraged了，取而代之的正是block：
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #3f1c7e;"><span style="color: #000000;"> [</span><span style="color: #743ca6;">UIView</span>animateWithDuration<span style="color: #000000;">:</span><span style="color: #2526d3;">5.0</span>animations<span style="color: #000000;">:^{</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">view.opacity = <span style="color: #2526d3;">0.5</span>;</pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">}];</pre>
</blockquote>
简单明了，一切就这么发生了..</p>

<p>可能有人会觉得block的语法很奇怪，不像是OOP的风格，诚然直接使用的block看起来破坏了OOP的结构，也让实例的内存管理出现了某些“看上去奇怪”的现象。但是通过typedef的方法，可以将block进行简单包装，让它的behaviour更靠近对象一些：
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';"><span style="color: #c22a9f;">typedef</span> <span style="color: #c22a9f;">double</span> (^unary_operation_t)(<span style="color: #c22a9f;">double</span> op);</pre>
</blockquote>
定义了一个接受一个double型作为变量，类型为unary_operation_t的block，之后在使用前用类似C的语法声明一个unary_operation_t类型的&#8221;实例&#8221;，并且定义内容后便可以直接使用这个block了～
<blockquote>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic'; color: #478186;">unary_operation_t<span style="color: #000000;"> square;</span></pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">square = ^(<span style="color: #c22a9f;">double</span> operand) {</pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';"><span style="color: #c22a9f;">return</span> operand * operand;</pre>
<pre style="margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Century Gothic';">}</pre>
</blockquote>
啰嗦一句的还是内存管理的问题，block始终不是对象，而block的内存管理自然也是和普通对象不一样。系统会为block在堆上分配内存，而当把block当做对象进行处理时（比如将其压入一个NSMutableArray），我们需要获取它的一份copy（比如[square copy]），并且在Array retain了这个block后将其释放（[square autorelease]是不错的选择）。而对于block本身和调用该block的实例，则可以放心：SDK会将调用block的实例自动retain，直至block执行完毕后再对实例release，因此不会出现block执行到一半，实例就被dealloc这样的尴尬的局面。</p>

<p>iOS SDK 4.0以后，随着block的加入很多特性也随之添加或者发生了升级。Apple所推荐的block使用范围包括以下几个方面：
<ul>
	<li>枚举——通过block获取枚举对象或控制枚举进程</li>
	<li>View动画——简单明了的方式规定动画</li>
	<li>排序——在block内写排序算法</li>
	<li>通知——当某事件发生后执行block内的代码</li>
	<li>错误处理——当错误发生时执行block代码</li>
	<li>完成处理——当方法执行完毕后执行block代码</li>
	<li>GCD多线程——多线程控制，关于这个以后有机会再写…</li>
</ul>
仔细研读4.0的SDK的话，会发现很多常用类中都加入了不少带block作为参数的方法，改变固有思维习惯，适应并尽可能利用block给程序上带来的便捷，无疑是提高效率和使代码优雅的很好的途径～</p>
</div>
	<!-- UJian Button BEGIN -->
	<div class="ujian-hook"></div>
	<script type="text/javascript">var ujian_config = {num:6,showType:3,lkrc:6};</script>
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=1549469"></script>
	<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
	<!-- UJian Button END -->

</article>

	<div class="share">
	如果您觉得这篇文章对您有帮助，请不吝分享让更多人知道 :)
	<span class='st_sina_large' displayText='Sina'></span>
	<span class='st_facebook_large' displayText='Facebook'></span>
	<span class='st_twitter_large' displayText='Tweet'></span>
	<span class='st_email_large' displayText='Email'></span>
	<span class='st_sharethis_large' displayText='ShareThis'></span>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2013 - onevcat -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'onevcat';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://onevcat.com/2011/11/objective-c%E4%B8%AD%E7%9A%84block/';
        var disqus_url = 'http://onevcat.com/2011/11/objective-c%E4%B8%AD%E7%9A%84block/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-25719337-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




		</div>
	</div>
</body>
</html>
